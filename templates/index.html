{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-running text-primary"></i> BarkRun Dashboard
        </h1>
    </div>
</div>

{% if current_user.is_authenticated and (current_user.is_admin() or current_user.is_organizer()) %}
<div class="row mb-3">
  <div class="col-12 d-flex justify-content-end">
    <button id="startRaceBtnTop" class="btn btn-danger">
      <i class="fas fa-play"></i> Start Race
    </button>
  </div>
  </div>
{% endif %}

{% if all_races is defined %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <strong><i class="fas fa-camera me-2"></i>Your races with photo status</strong>
            </div>
            <div class="card-body p-0">
                {% if all_races %}
                <div class="list-group list-group-flush">
                    {% for race in all_races %}
                    {% set claimed = race.id in claimed_race_ids %}
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                       href="{{ url_for('my_race_photos', race_id=race.id) if claimed else url_for('find_me', race_id=race.id) }}">
                        <span class="d-flex align-items-center gap-2">
                            {% if claimed %}
                                {% set rank = claimed_photo_rank_by_race.get(race.id) if claimed_photo_rank_by_race is defined else None %}
                                {% if rank %}
                                <span class="badge bg-info text-dark">#{{ rank }}</span>
                                {% endif %}
                                <i class="fas fa-flag-checkered text-secondary"></i>
                            {% else %}
                                <i class="fas fa-camera text-danger"></i>
                            {% endif %}
                            <strong class="ms-1">
                                {% if race.start_time %}
                                    {{ race.start_time | format_dt_paris('%Y-%m-%d %H:%M:%S %Z') }}
                                {% else %}
                                    {{ race.date.strftime('%Y-%m-%d') }} 00:00:00 CEST
                                {% endif %}
                            </strong>
                        </span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-muted">No races available.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <!-- Stats cards temporarily hidden; keep for future use
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_users }}</h4>
                        <p class="mb-0">Users</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_races }}</h4>
                        <p class="mb-0">Races</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-flag-checkered fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_results }}</h4>
                        <p class="mb-0">Results</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-trophy fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    -->
    <!--
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        {% if last_started_race %}
                            <h6 class="mb-1">Last Race Started</h6>
                            <p class="mb-0">{{ last_started_race.start_time | format_dt_paris }}</p>
                        {% else %}
                            <h6 class="mb-1">Last Race Started</h6>
                            <p class="mb-0">No races yet</p>
                        {% endif %}
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    -->
</div>

<!-- Recent Results section removed per request -->
{% endblock %}

{% block scripts %}
<script>
async function startRaceFlow() {
  try {
    const checkResp = await fetch("{{ url_for('check_ongoing_race') }}");
    const check = await checkResp.json();
    let force = 0;
    if (check.ongoing) {
      const confirmNew = confirm(`A race started at ${new Date(check.start_time).toLocaleString()} is ongoing. Start a new one and end the current?`);
      if (!confirmNew) return;
      force = 1;
    }
    const form = new URLSearchParams();
    form.append('force', String(force));
    const resp = await fetch("{{ url_for('start_race') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
    if (resp.status === 409) {
      const data = await resp.json();
      const confirmNew = confirm('A race is ongoing. End it and start a new one?');
      if (!confirmNew) return;
      form.set('force', '1');
      const resp2 = await fetch("{{ url_for('start_race') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
      if (!resp2.ok) throw new Error('Failed to start race');
    } else if (!resp.ok) {
      throw new Error('Failed to start race');
    }
    window.location.reload();
  } catch (e) {
    alert(e.message || 'Error starting race');
  }
}

for (const id of ['startRaceBtnQA','startRaceBtnEmpty','startRaceBtnTop']) {
  const el = document.getElementById(id);
  if (el) el.addEventListener('click', startRaceFlow);
}
</script>
{% endblock %}
