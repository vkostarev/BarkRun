{% extends "base.html" %}

{% block title %}{{ user.name }} - Organizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card profile-card">
            <div class="card-body text-center">
                <i class="fas fa-users-cog fa-4x mb-3"></i>
                <h4>{{ user.name }}</h4>
                <p class="mb-2">{{ user.email }}</p>
                <span class="badge bg-light text-dark">{{ user.role.title() }}</span>
                <hr class="my-4">
                <div class="row text-center">
                    <div class="col-6">
                        <h5>{{ user.age or '-' }}</h5>
                        <small>Age</small>
                    </div>
                    <div class="col-6">
                        <h5>{{ user.gender or '-' }}</h5>
                        <small>Gender</small>
                    </div>
                </div>
                <hr class="my-4">
                <div class="text-center">
                    <h5>{{ races|length }}</h5>
                    <small>Organized Races</small>
                </div>
                <p class="mt-3 mb-0"><small>Member since {{ user.created_at | format_dt_paris('%B %Y') }}</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-flag-checkered"></i> My Races</h4>
            <div class="d-flex gap-2">
                <button id="startRaceBtn" class="btn btn-lg btn-danger">
                    <i class="fas fa-play"></i> Start Race
                </button>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                {% if races %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Race</th>
                                <th>Start (Paris)</th>
                                <th>Distance</th>
                                <th>Location</th>
                                <th>Results</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for race in races %}
                            <tr>
                                <td><strong>{{ race.name }}</strong></td>
                                <td>{{ race.start_time | format_dt_paris('%Y-%m-%d %H:%M %Z') }}</td>
                                <td>{{ race.distance }} km</td>
                                <td>{{ race.location or '-' }}</td>
                                <td><span class="badge bg-primary">{{ race.results|length }}</span></td>
                                <td>
                                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload_race_photos', race_id=race.id) }}">
                                        <i class="fas fa-upload"></i> Upload Photos
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-flag fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No races yet</h5>
                    <p class="text-muted">Press Start Race to create one now.</p>
                    <button id="startRaceBtnEmpty" class="btn btn-danger btn-lg">
                        <i class="fas fa-play"></i> Start Race
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('startRaceBtn').addEventListener('click', async () => {
  try {
    // Check if an ongoing race exists
    const checkResp = await fetch("{{ url_for('check_ongoing_race') }}");
    const check = await checkResp.json();
    let force = 0;
    if (check.ongoing) {
      const dt = new Date(check.start_time);
      const parisStr = new Intl.DateTimeFormat('en-GB', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false, timeZone: 'Europe/Paris', timeZoneName: 'short'
      }).format(dt);
      const confirmNew = confirm(`A race started at ${parisStr} (Paris) is ongoing. Start a new one and end the current?`);
      if (!confirmNew) return;
      force = 1;
    }
    const form = new URLSearchParams();
    form.append('force', String(force));
    const resp = await fetch("{{ url_for('start_race') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
    if (resp.status === 409) {
      // Server says ongoing but no force; re-run with force after confirm
      const data = await resp.json();
      const confirmNew = confirm('A race is ongoing. End it and start a new one?');
      if (!confirmNew) return;
      form.set('force', '1');
      const resp2 = await fetch("{{ url_for('start_race') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
      if (!resp2.ok) throw new Error('Failed to start race');
    } else if (!resp.ok) {
      throw new Error('Failed to start race');
    }
    // Reload to reflect new race
    window.location.reload();
  } catch (e) {
    alert(e.message || 'Error starting race');
  }
});
const startEmpty = document.getElementById('startRaceBtnEmpty');
if (startEmpty) startEmpty.addEventListener('click', () => document.getElementById('startRaceBtn').click());
</script>
{% endblock %}
